{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="card mb-4 border-success">
    <div class="card-header bg-success text-white fw-bold">
        ğŸ’° ä»Šæ—¥ã®å¸‚æ³ã‚³ãƒ¡ãƒ³ãƒˆ
    </div>
    <div class="card-body">
        <p class="card-text">{{ summary | replace('\n', '<br>') | safe }}</p>
    </div>
</div>

<div class="row">
    {% if fg_index %}
    <div class="col-12 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                <span>ğŸ˜¨ Fear & Greed Index (å¸‚å ´å¿ƒç†)</span>
                <span class="badge bg-light text-dark">{{ fg_index.rating }}</span>
            </div>
            <div class="card-body text-center" style="position: relative;">
                <div style="max-height: 250px; position: relative; margin: 0 auto; width: 100%; max-width: 400px;">
                    <canvas id="chart-fg"></canvas>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; text-align: center; margin-bottom: 20px;">
                        <h1 class="display-4 fw-bold mb-0" id="fg-score-text">{{ fg_index.score }}</h1>
                        <small class="text-muted">0(ææ€–) â†” 100(å¼·æ¬²)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% for key, item in data.items() %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">{{ item.name }}</span>
                <span class="badge {% if '+' in item.diff %}bg-danger{% else %}bg-secondary{% endif %}">
                    {{ item.current }} ({{ item.diff }})
                </span>
            </div>
            <div class="card-body">
                <canvas id="chart-{{ key }}"></canvas>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // --- 1. å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã®ã‚°ãƒ©ãƒ• ---
    const marketData = {{ data | tojson }};

    for (const [key, item] of Object.entries(marketData)) {
        const ctx = document.getElementById('chart-' + key).getContext('2d');
        const lineColor = item.color === 'red' ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)';
        const bgColor = item.color === 'red' ? 'rgba(255, 99, 132, 0.1)' : 'rgba(54, 162, 235, 0.1)';

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: item.dates,
                datasets: [{
                    label: item.name,
                    data: item.prices,
                    borderColor: lineColor,
                    backgroundColor: bgColor,
                    borderWidth: 2,
                    pointRadius: 1,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true },
                    y: { display: true, beginAtZero: false }
                }
            }
        });
    }

    // --- 2. ææ€–æŒ‡æ•°ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ (ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°) ---
    {% if fg_index %}
    const fgCtx = document.getElementById('chart-fg').getContext('2d');
    const score = {{ fg_index.score }};
    
    // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸè‰²æ±ºå®š
    let meterColor = '#ffc107'; // é»„ (Neutral)
    if (score < 25) meterColor = '#dc3545'; // èµ¤ (Extreme Fear)
    else if (score < 45) meterColor = '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸ (Fear)
    else if (score > 75) meterColor = '#198754'; // ç·‘ (Extreme Greed)
    else if (score > 55) meterColor = '#20c997'; // é’ç·‘ (Greed)

    new Chart(fgCtx, {
        type: 'doughnut',
        data: {
            labels: ['Score', 'Remaining'],
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: [
                    meterColor,
                    '#e9ecef' // ã‚°ãƒ¬ãƒ¼èƒŒæ™¯
                ],
                borderWidth: 0,
                cutout: '85%', // ãƒ‰ãƒ¼ãƒŠãƒ„ã®å¤ªã•
            }]
        },
        options: {
            responsive: true,
            rotation: -90,      // å·¦ã‹ã‚‰é–‹å§‹
            circumference: 180, // åŠå††ã«ã™ã‚‹
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
